<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂõõÂúãÂÜíÈö™Êó•Ë™å V9.0</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&family=Noto+Serif+TC:wght@900&display=swap" rel="stylesheet">
    <style>
        :root { --maple-bg: #87CEEB; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: var(--maple-bg);
            background-image: url('https://i.pinimg.com/originals/1e/86/82/1e8682d029094054a138c2084c83091e.jpg');
            background-size: cover; background-attachment: fixed; background-position: center bottom;
            margin: 0; padding: 8px; color: #333; padding-bottom: 60px; overflow-x: hidden;
        }
        .quest-window {
            max-width: 600px; margin: 5px auto; background: #FDFDFD;
            border: 2px solid #888; border-radius: 12px;
            box-shadow: 0 0 0 3px #555, 0 10px 20px rgba(0,0,0,0.4); overflow: hidden; position: relative; z-index: 10;
        }
        .window-header {
            background: linear-gradient(to bottom, #4b6cb7, #182848);
            padding: 10px 15px; color: white; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 3px solid #333;
        }
        .header-icon {
            width: 40px; height: 40px; object-fit: contain; margin-right: 10px;
            filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.5)); animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        
        .tabs { display: flex; width: 100%; background: #E0E0E0; border-bottom: 2px solid #AAA; }
        .tab-btn {
            flex: 1; background: linear-gradient(to bottom, #f8f8f8, #dcdcdc);
            border-right: 1px solid #999; border-bottom: none; padding: 10px 0; cursor: pointer;
            font-weight: 800; color: #555; font-size: 16px; text-align: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .tab-btn:last-child { border-right: none; }
        .tab-btn.active { background: #FFF; color: #000; box-shadow: inset 0 -4px 0 #FFCC00; }
        .tab-sub { font-size: 11px; font-weight: normal; color: #666; margin-top: 2px; }
        .tab-btn.active .tab-sub { color: #000; font-weight: bold; }
        
        .content-area { background: #FFF; padding: 15px; min-height: 480px; position: relative; }
        
        .weather-panel {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border: 2px solid #1E88E5; border-radius: 12px; padding: 12px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: space-between; box-shadow: 3px 3px 0 rgba(0,0,0,0.1);
        }
        .weather-loc { font-size: 15px; font-weight: 900; color: #1565C0; }
        .weather-detail { font-size: 12px; color: #0D47A1; margin-top: 4px; font-weight: bold;}
        .weather-right { text-align: right; }
        .weather-icon { font-size: 32px; display: block; margin-bottom: -5px; }
        .weather-temp { font-size: 26px; color: #D84315; font-weight: 900; }
        .weather-fallback-btn {
            display: inline-block; background: #fff; color: #1565C0; text-decoration: none;
            padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold;
            margin-top: 5px; border: 1px solid #1565C0;
        }

        .sub-nav-container {
            display: flex; gap: 10px; margin-bottom: 20px; background: #EEE; padding: 5px; border-radius: 8px;
        }
        .sub-nav-btn {
            flex: 1; padding: 10px; border: 2px solid transparent; border-radius: 6px;
            font-weight: bold; cursor: pointer; background: #CCC; color: #555;
        }
        .sub-nav-btn.active-main { background: #FFF; border-color: #FFCC00; color: #333; }
        .sub-nav-btn.active-backup { background: #E6E6FA; border-color: #9370DB; color: #4B0082; }

        .quest-list { list-style: none; padding: 0; margin: 0; }
        .quest-item { border-bottom: 1px dashed #CCC; padding: 15px 0; }
        .quest-item:last-child { border-bottom: none; }
        .quest-header { display: flex; align-items: center; margin-bottom: 8px; }
        .quest-time {
            background: #333; color: #FFCC00; padding: 3px 8px; border-radius: 4px;
            font-size: 14px; font-weight: bold; margin-right: 10px; min-width: 60px; text-align: center;
        }
        .quest-title { font-size: 18px; font-weight: 800; color: #222; display: flex; align-items: center; }
        /* ÂúñÁ§∫Ê®£Âºè */
        .event-icon-img { width: 30px; height: 30px; margin-left: 8px; object-fit: contain; vertical-align: middle; }
        .quest-desc { font-size: 15px; color: #555; margin: 0 0 12px 0; line-height: 1.4; padding-left: 2px; }

        /* ÊåâÈàïÁæ§ÁµÑ */
        .action-btns { display: flex; gap: 8px; margin-top: 10px; }
        .btn {
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px; font-weight: bold; font-size: 15px; text-decoration: none; color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: 0.1s; border: 1px solid rgba(0,0,0,0.1);
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        
        /* Â∞éËà™ÊåâÈàï (Â∑¶ÈÇäÈï∑) */
        .btn-nav { flex: 1; background: linear-gradient(to bottom, #4facfe, #00f2fe); padding: 12px; }
        
        /* Ë≥áË®äÊåâÈàï (Âè≥ÈÇäÁü≠ÈªÉËâ≤) */
        .btn-info { 
            width: 60px; background: linear-gradient(to bottom, #ffd200, #f7971e); color: white; 
            font-size: 18px; text-shadow: 0 1px 1px rgba(0,0,0,0.3);
        }
        
        .btn-hotel { width:100%; background: linear-gradient(to bottom, #ff758c, #ff7eb3); font-size: 20px; padding: 18px; margin-top: 20px;}

        .npc-dialog {
            background: #FFF8DC; border: 2px solid #DAA520; border-radius: 12px;
            padding: 15px 15px 15px 65px; position: relative; margin-top: 25px;
            font-size: 14px; line-height: 1.6; color: #4A3B2A; z-index: 5;
        }
        .npc-dialog::before {
            content: ''; width: 50px; height: 50px;
            background-image: url('https://maplestory.io/api/gms/62/mob/1210102/render/move?center=true');
            background-size: contain; background-repeat: no-repeat;
            position: absolute; left: 8px; top: 50%; transform: translateY(-50%);
        }

        .exp-bar-container {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 40px;
            background: #2b2b2b; border-top: 2px solid #555;
            display: flex; align-items: center; padding: 0 15px; z-index: 999;
        }
        .exp-track { flex: 1; height: 16px; background: #111; border-radius: 8px; overflow: hidden; }
        .exp-fill { height: 100%; background: linear-gradient(to bottom, #00FF00, #00CC00); width: 0%; transition: 0.5s; }

        #bgText {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg);
            font-family: 'Noto Serif TC', serif; font-size: 80px; font-weight: 900;
            color: rgba(0,0,0,0.08); white-space: nowrap; pointer-events: none; z-index: 0;
        }
        .snowflake {
            position: fixed; top: -10px; z-index: 9999; color: #FFF; font-size: 1em; opacity: 0.8;
            user-select: none; pointer-events: none; animation: fall linear infinite; text-shadow: 0 0 2px #000;
        }
        @keyframes fall { 0% { transform: translateY(-10vh) translateX(0); } 100% { transform: translateY(110vh) translateX(20px); } }
        .snow-container { display: none; }

    </style>
</head>
<body>

<div class="quest-window">
    <div class="window-header">
        <div style="display:flex; align-items:center;">
            <img id="headerIconImg" src="" class="header-icon" alt="icon">
            <div style="font-size:18px; text-shadow:1px 1px 0 #000;">üçÅ Ë≥úÂúãÁé©ÂõõÂúã</div>
        </div>
        <div style="font-size:12px; background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px;">LV.2026 Êó•Êú¨ÂõõÂúãÂàùÂøÉËÄÖ</div>
    </div>

    <div class="tabs">
        <div class="tab-btn active" onclick="loadDay(1)">D1<span class="tab-sub">È´òÊùæ</span></div>
        <div class="tab-btn" onclick="loadDay(2)">D2<span class="tab-sub">Â∞èË±ÜÂ≥∂</span></div>
        <div class="tab-btn" onclick="loadDay(3)">D3<span class="tab-sub">ÈáëÂàÄÊØîÁæÖ</span></div>
        <div class="tab-btn" onclick="loadDay(4)">D4<span class="tab-sub">ÂÄâÊï∑</span></div>
        <div class="tab-btn" onclick="loadDay(5)">D5<span class="tab-sub">ËøîÁ®ã</span></div>
        <div class="tab-btn" onclick="loadDay('info')">INFO<span class="tab-sub">‰ΩèÂÆø</span></div>
    </div>

    <div class="content-area" id="mainContent">
        <div id="bgText">Êµ∑Â∫ïÊíàÊúà</div>
    </div>
</div>

<div class="exp-bar-container">
    <span style="color:#FFCC00; font-weight:900; margin-right:10px;">EXP</span>
    <div class="exp-track"><div class="exp-fill" id="expFill"></div></div>
    <span style="color:white; font-size:12px; margin-left:10px;" id="expText">0%</span>
</div>

<div id="snowContainer" class="snow-container"></div>

<script>
    // =========================================================
    // üé® ÂÖßÂª∫ Base64 ÂúñÁ§∫Â∫´ (Êñ∞Â¢ûÔºöÈ£Ø„ÄÅÁõ∏Ê©ü„ÄÅËªä„ÄÅË≥ºÁâ©)
    // =========================================================
    
    const HEADER_ICON_SRC = "https://maplestory.io/api/gms/62/mob/1210100/render/move?center=true";

    // ËèØËà™È£õÊ©ü
    const PLANE_ICON = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjRTMwMDc5IiBkPSJNMzUuNCAyNDQuOGMtMi45IDguNSAxLjYgMTcuNyAxMC4zIDIwLjUgOC43IDIuOCAxOC4xLTIgMjEuMS0xMC41IDMuMS04LjYtMS42LTE3LjktMTAuNC0yMC43LTguNi0yLjgtMTguMSAxLjktMjEgMTAuN3ptMTI4LjIgOTEuMWMtMTYuNy01LjMtMjUuMSA4LjgtMTguNCAxOS45IDUuMiA4LjUgMTkuMiA5LjIgMzEuOSAzLjggMTEuNy01IDExLjItMTcuNS41LTIxLjQtNC4xLTEuNS05LjItMi4yLTE0LTIuM3ptLTgwLjUgNzEuOGMtMTQuMyAxNS41IDUgMzIuMyAyMS40IDMwLjUgMTIuOS0xLjQgMTguNi0xMi42IDE0LjUtMjIuOS0zLjMtOC40LTE1LjYtMTQuNC0yNi41LTEyLjN6bTMxOS41LTg4LjJjLTE4LjUgMjMuNi00Ny41IDM4LjMtNjQuMyA1My4yLTIyLjYgMjAuMS0yNS4xIDUyLjEtMy41IDczLjEgMjEuNCAyMC45IDU4LjMgMTYuNCA4My44LTEwLjIgMjMuNS0yNC42IDMyLjUtNTcuMyAxNS45LTk4LjctNi41LTE2LjEtMTgtMTkuOS0zMS45LTE3LjR6bS0xMzUuMy01LjRjLTEuOS0xNS41LTE2LjgtMjEuMy0zMy0xMi45LTE2LjEgOC40LTE2LjggMjguNi0xLjMgMzQuNCAxMS42IDQuMyAyNy41LTMuMyAzMi43LTE2LjEgMS4xLTIuNyAxLjYtNS40IDEuNi01LjR6bTE0LjkgMTY4LjJjLTI1LjEgNi42LTI4LjIgNDAuNS00LjUgNDguMyAxOC42IDYuMSAzNy44LTE1IDMxLjQtMzcuNS0zLjUtMTIuMy0xNi45LTE1LjctMjYuOS0xMC44em0tMjIxLjYgMi44Yy04LjUgMTEuMS0yLjIgMjcuMiAxMS43IDI5LjUgMTEuMSAxLjkgMTguNC0xMC4xIDEyLjctMjAuNS00LjctOC41LTE1LjktMTQuOS0yNC40LTl6bTMzNi40LTI4LjRjLTIzLjUtOC42LTM1LjUgMTguNi0xOC40IDM2LjggMTMuNSAxNC4zIDM3LjMgNyAzOC0xMS44LjUtMTQuOC0xMC4xLTIxLjUtMTkuNi0yNXoiLz48L3N2Zz4=";
    // Ëàπ
    const BOAT_ICON = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjMzA0RkZFIiBkPSJNMzIuNCAzNjUuOWM0OC45IDE4LjYgODcuOSAxNiAxMjQuOCAwIDM2LjktMTYuMSA3Ni0xOC42IDEyNC44IDAgNDguOSAxOC42IDg3LjkgMTYgMTI0LjggMCAzNi45LTE2LjEgNzYtMTguNiAxMjQuOCAwIDYuMSA4LjkgNC42IDE4LjIgMy41IDI1LjctMS4xIDcuNC02LjEgMTAuMy0xMi4yIDcuNC0zNi45LTE2LjEtNzYtMTguNi0xMjQuOCAwLTQ4LjkgMTguNi04Ny45IDE2LTEyNC44IDAtMzYuOSAxNi4xLTc2IDE4LjYtMTI0LjggMC0zNy0xNi4xLTc1LjktMTguNi0xMjQuOCAwLTQuOS0yLjEtMTEuMS01LTE4LjMtOC41LTcuMS0zLjQtMTMuNi0uNi0xNC41IDUuOHptNDUuMi02Ny42bDIzLjQtMTg2LjRjMS41LTExLjggMTEuNS0yMC40IDIzLjMtMjAuNGgyNDguMWMxMS44IDAgMjEuOCA4LjYgMjMuMyAyMC40bDIzLjQgMTg2LjRjLTMwLjItNy44LTcyLjMtNi41LTEwOC41IDUuOC0zNi45IDE2LjEtNzYgMTguNi0xMjQuOCAwLTM5LjktMTMuNi04NS41LTEzLjYtMTA4LjItNS44eiIvPjwvc3ZnPg==";
    // ÁæéÈ£ü (Food)
    const FOOD_ICON = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjRkY5ODAwIiBkPSJNMTYwIDk2Yy0xNy43IDAtMzIgMTQuMy0zMiAzMnYyMjRjMCAxNy43IDE0LjMgMzIgMzIgMzJzMzItMTQuMyAzMi0zMlYxMjhjMC0xNy43LTE0LjMtMzItMzItMzJem0xOTIgMGMtMTcuNyAwLTMyIDE0LjMtMzIgMzJ2MjI0YzAgMTcuNyAxNC4zIDMyIDMyIDMyczMyLTE0LjMgMzItMzJWMTI4YzAtMTcuNy0xNC4zLTMyLTMyLTMyem0tOTYgMGMtMTcuNyAwLTMyIDE0LjMtMzIgMzJ2MjI0YzAgMTcuNyAxNC4zIDMyIDMyIDMyczMyLTE0LjMgMzItMzJWMTI4YzAtMTcuNy0xNC4zLTMyLTMyLTMyek0zMiAzMjB2MzJjMCA1MyAzNS44IDk3IDg0LjYgMTA5LjEgOS43IDYwLjIgNjIuMyAxMDYuNCAxMjUuMyAxMDYuOXMtMTE1LjYtNDYuNy0xMjUuMy0xMDYuOUM0NTIuMiA0NDkgNDg4IDQwNSA0ODggMzUydi0zMmMwLTE3LjctMTQuMy0zMi0zMi0zMmgtNjRjLTE3LjcgMC0zMiAxNC4zLTMyIDMydjMyYzAgMTcuNy0xNC4zIDMyLTMyIDMycy0zMi0xNC4zLTMyLTMydi0zMmMwLTE3LjctMTQuMy0zMi0zMi0zMmgtMzJjLTE3LjcgMC0zMiAxNC4zLTMyIDMydjMyYzAgMTcuNy0xNC4zIDMyLTMyIDMycy0zMi0xNC4zLTMyLTMydi0zMmMwLTE3LjctMTQuMy0zMi0zMi0zMkgyNTZjLTE3LjcgMC0zMiAxNC4zLTMyIDMydjMyYzAgMTcuNy0xNC4zIDMyLTMyIDMycy0zMi0xNC4zLTMyLTMydi0zMmMwLTE3LjctMTQuMy0zMi0zMi0zMkg2NGMtMTcuNyAwLTMyIDE0LjMtMzIgMzJ6Ii8+PC9zdmc+";
    // ÊôØÈªû (Sight)
    const SIGHT_ICON = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjNENBRjUwIiBkPSJNMCAyNTZDMCAxMTQuNiAxMTQuNiAwIDI1NiAwczI1NiAxMTQuNiAyNTYgMjU2LTExNC42IDI1Ni0yNTYgMjU2UzAgMzk3LjQgMCAyNTZ6bTE4NyAxMzIuM2wxMjUuNC03NS43Yy42LS40IDEuNS0uNCAyLjEgMGwxMjUuNCA3NS43YzEuNyAxIDMuOC0uMiAzLjgtMi4xVjIxNi4zYzAtMS4xLS42LTIuMS0xLjYtMi43bC0xMjcuNi03Ny4zYy0xLjItLjctMi43LS43LTMuOSAwTCAxODUuNCAyMTMuNmMtMSAuNi0xLjYgMS42LTEuNiAyLjd2MTcwLjRjMCAxLjkgMi4xIDMuMSAzLjggMi4xem0yMjEuMi03Ni42bC0zNi4yLTIxLjggMzYuMi0yMi4xYzEuMi0uNyAxLjYtMi4yLjktMy40bC0yMC4xLTMzLjRjLS43LTEuMi0yLjItMS42LTMuNC0uOWwtMzUuNiAyMS44VjEyOC4zYzAtMS40LTEuMS0yLjUtMi41LTIuNWgtMzkuMWMtMS40IDAtMi41IDEuMS0yLjUgMi41djYxLjZsLTM1LjYtMjEuOGMtMS4yLS43LTIuNy0uMy0zLjQuOWwtMjAuMSAzMy40Yy0uNyAxLjItLjMgMi43LjkgMy40bDM2LjIgMjIuMS0zNi4yIDIxLjhjLTEuMi43LTEuNiAyLjItLjkgMy40bDIwLjEgMzMuNGMuNyAxLjIgMi4yIDEuNiAzLjQuOWwzNS42LTIxLjh2NjEuNmMwIDEuNCAxLjEgMi41IDIuNS 2LjVoMzkuMWMxLjQgMCAyLjUtMS4xIDIuNS0yLjVWMjkwbDM1LjYgMjEuOGMxLjIuNy 2LjcuMyAzLjQtLjlsMjAuMS0zMy40Yy43LTEuMi4zLTIuNy0uOS0zLjR6Ii8+PC9zdmc+";
    // Ë≥ºÁâ© (Shop)
    const SHOP_ICON = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjRTkxRTYzIiBkPSJNMTkyIDEyOHYtMzJjMC0zNS4zIDI4LjctNjQgNjQtNjRzNjQgMjguNyA2NCA2NHYzMmg4MGMxNy43IDAgMzIgMTQuMyAzMiAzMnYzMjBjMCAxNy43LTE0LjMgMzItMzIgMzJINzZjLTE3LjcgMC0zMi0xNC4zLTMyLTMyVjE2MGMwLTE3LjcgMTQuMy0zMiAzMi0zMmgxMTZ6bTQ4LTMyYzAtOC44LTcuMi0xNi0xNi0xNnMtMTYgNy4yLTE2IDE2djMyaDMydi0zMnoiLz48L3N2Zz4=";
    // Ëªä (Car)
    const CAR_ICON = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjMjE5NkkzIiBkPSJNMTM1LjIgMTc2aDI0MS42YzguNSAwIDE1LjYtNi40IDE2LjgtMTQuOGwxNi4zLTExNC4xYy43LTUuMS0zLjItOS43LTguNC05LjdINTEwLjVjLTUuMiAwLTkuMiA0LjYtOC40IDkuN2wxNi4zIDExNC4xYzEuMiA4LjQgOC4zIDE0LjggMTYuOCAxNC44em0wIDMyYy0zNC41IDAtNjMuOSAyMi03My40IDU0LjJMNCAzODkuNGMtMi4yIDcuNSAzLjQgMTUuMyAxMS4yIDE1LjNoNDgxLjZjNy44IDAgMTMuNC03LjggMTEuMi0xNS4zTDQ1MC4yIDI2Mi4yYy05LjUtMzIuMi0zOC45LTU0LjItNzMuNC01NC4ySDEzNS4yem0zOC44IDEyOGMyMy4yIDAgNDIgMTguOCA0MiA0MnMtMTguOCA0Mi00MiA0Mi00Mi0xOC44LTQyLTQyIDE4LjgtNDIgNDItNDJ6bTMyOCAwYzIzLjIgMCA0MiAxOC44IDQyIDQyczLTE4LjggNDItNDIgNDItNDItMTguOC00Mi00MiAxOC44LTQyIDQyLTQyeiIvPjwvc3ZnPg==";

    document.getElementById('headerIconImg').src = HEADER_ICON_SRC;

    const ICONS = {
        plane: PLANE_ICON,
        boat: BOAT_ICON,
        food: FOOD_ICON,
        sight: SIGHT_ICON,
        shop: SHOP_ICON,
        car: CAR_ICON
    };

    // =========================================================
    // üìÖ Ë°åÁ®ãË≥áÊñô (V9.0 - ÂÖ®ÂúñÁ§∫Áâà)
    // =========================================================
    const itinerary = {
        1: {
            title: "Day 1ÔΩúÊäµÈÅîÈ´òÊùæ",
            date: "1/23 (‰∫î)", location: "Takamatsu", lat: 34.3428, long: 134.0466,
            events: [
                { time: "07:00", title: "CI278 Ê°ÉÂúíËµ∑È£õ", desc: "ÂâçÂæÄÈ´òÊùæÔºåÂÜíÈö™ÈñãÂßãÔºÅ", lat: 25.0797, lng: 121.2342, icon: 'plane' },
                { time: "10:20", title: "ÊäµÈÅîÈ´òÊùæÁ©∫Ê∏Ø", desc: "ÂÖ•Â¢ÉÊâãÁ∫å„ÄÅÂèñËªä", lat: 34.2142, lng: 134.0157, icon: 'car' },
                { time: "12:00", title: "ÁßüËªä & ÂçàÈ§ê", desc: "Ê∂Æ‰πÉËëâ (ÂêÉÈ£ΩÂá∫Áôº)", lat: 34.2963, lng: 134.0441, link: "https://maps.app.goo.gl/KdNuojGtmtbTNwVn7", icon: 'food' },
                { time: "13:30", title: "Ê†óÊûóÂÖ¨Âúí", desc: "Á±≥ÂÖ∂Êûó‰∏âÊòüÂ∫≠Âúí (2H)", lat: 34.3297, lng: 134.0444, icon: 'sight' },
                { time: "17:30", title: "ÂïÜÂ∫óË°óÊï£Á≠ñ", desc: "ÂÖ´Â§ßÊ¢ùÂïÜÂ∫óË°óËá™Áî±ÈÄõ", lat: 34.3444, lng: 134.0522, icon: 'shop' },
                { time: "18:30", title: "Vent Buffet", desc: "ÊôöÈ§êÊôÇÂÖâ", lat: 34.3512, lng: 134.0560, link: "https://maps.app.goo.gl/uX7nC3x7z8x9", icon: 'food' }
            ],
            note: "Á¨¨‰∏ÄÂ§©ËºïÈ¨ÜÈªûÔºåÈÅ©ÊáâÂè≥Èßï„ÄÇ"
        },
        2: {
            title: "Day 2ÔΩúÂ∞èË±ÜÂ≥∂",
            date: "1/24 (ÂÖ≠)", location: "Shodoshima", lat: 34.4950, long: 134.2706,
            events: [
                { time: "08:00", title: "È´òÊùæÊ∏Ø ‚Üí ÂúüÂ∫ÑÊ∏Ø", desc: "Êê≠‰πòÊ∏°Ëº™ (Á¥Ñ1H)", lat: 34.3524, lng: 134.0520, icon: 'boat' },
                { time: "09:30", title: "Ê©ÑÊ¨ñÂÖ¨Âúí", desc: "È≠îÂ•≥ÂÆÖÊÄ•‰æøÊéÉÂ∏öÊãçÁÖß", lat: 34.4754, lng: 134.2947, icon: 'sight' },
                { time: "11:30", title: "ÈÜ¨‰πãÈÑâ", desc: "ÈÜ¨Ê≤πÈúúÊ∑áÊ∑ã", lat: 34.4633, lng: 134.3317, icon: 'food' },
                { time: "14:00", title: "Â§©‰Ωø‰πãË∑Ø", desc: "ÈÄÄÊΩÆÊ≤ôÁÅòÊï£Ê≠•", lat: 34.4746, lng: 134.1849, icon: 'sight' },
                { time: "16:00", title: "ËøîÂõûÈ´òÊùæ", desc: "Êê≠ËàπÂõûÂ∏ÇÂçÄ", lat: 34.4827, lng: 134.1754, icon: 'boat' }
            ],
            note: `Ëã•Êµ∑Ê≥Å‰∏ç‰Ω≥ÔºåBË®àÁï´ÊîπÂéª„ÄåÊªøÊøÉÂÖ¨Âúí„Äç„ÄÇ<br><a href="https://www.google.com/maps/dir/?api=1&destination=34.1678,133.8647&travelmode=driving" target="_blank" style="color:red; font-weight:bold; text-decoration:underline;">üî¥ ÈªûÊàëÈñãÂßãÂ∞éËà™ÂéªÊªøÊøÉÂÖ¨Âúí</a>`
        },
        3: {
            title: "Day 3ÔΩúÂΩàÊÄßÈÅ∏ÊìáÊó•",
            date: "1/25 (Êó•)", location: "Kotohira", lat: 34.1923, long: 133.8202,
            eventsMain: [
                { time: "09:00", title: "ÈáëÂàÄÊØîÁæÖÂÆÆ", desc: "ÊåëÊà∞1368ÈöéÊ¢ØÔºåÂèÉÊãúÁãóÁãóÁ•û", lat: 34.1837, lng: 133.8122, icon: 'sight' },
                { time: "12:30", title: "Â±±Ë∂äÁÉèÈæçÈ∫µ", desc: "ÁÉèÈæçÈ∫µÂêçÂ∫óÂçàÈ§ê", lat: 34.2384, lng: 133.9213, icon: 'food' },
                { time: "14:30", title: "ÊªøÊøÉÂÖ¨Âúí", desc: "ÂúãÁáüÂÖ¨ÂúíË≥ûËä±Êï£Ê≠•", lat: 34.1678, lng: 133.8647, icon: 'sight' },
                { time: "18:00", title: "Â∏ÇÂçÄÊôöÈ§ê", desc: "ËøîÂõûÈ´òÊùæ", lat: 34.3428, lng: 134.0466, icon: 'food' }
            ],
            eventsBackup: [
                { time: "09:00", title: "ÂâçÂæÄÁî∑Êú®Â≥∂", desc: "È´òÊùæÊ∏ØÊê≠ËàπÂâçÂæÄ", lat: 34.3524, lng: 134.0520, icon: 'boat' },
                { time: "10:00", title: "Áî∑Êú®Â≥∂ (Ë≤ìÂ≥∂)", desc: "Ë±êÁéâÂß¨Á•ûÁ§æ„ÄÅÊìºË≤ìÊï£Ê≠•", lat: 34.4262, lng: 134.0560, icon: 'sight' },
                { time: "13:00", title: "ËøîÂõûÈ´òÊùæ", desc: "Â∏ÇÂçÄÂçàÈ§ê & Ë≥ºÁâ©", lat: 34.3428, lng: 134.0466, icon: 'shop' },
                { time: "15:00", title: "ÂÆ§ÂÖßË°åÁ®ã", desc: "ÂïÜÂ∫óË°ó / ÂíñÂï°Âª≥‰ºëÊÅØ", lat: 34.3444, lng: 134.0522, icon: 'food' }
            ],
            note: "Ê†πÊìöÁï∂Â§©È´îÂäõÂíåÂ§©Ê∞£ÔºåËá™Áî±ÂàáÊèõ‰∏äÊñπÊåâÈàïÈÅ∏ÊìáË°åÁ®ãÔºÅ"
        },
        4: {
            title: "Day 4ÔΩúÂÄâÊï∑‰∏ÄÊó•ÈÅä",
            date: "1/26 (‰∏Ä)", location: "Kurashiki", lat: 34.5951, long: 133.7667,
            events: [
                { time: "08:00", title: "ÂâçÂæÄÂÄâÊï∑", desc: "Ëá™Èßï/JR (ÁÄ®Êà∂Â§ßÊ©ã)", lat: 34.5951, lng: 133.7667, icon: 'car' },
                { time: "10:00", title: "ÂÄâÊï∑ÁæéËßÄÂú∞ÂçÄ", desc: "ÈÅãÊ≤≥ÈÅäËàπ„ÄÅÂè§Ë°óÊï£Ê≠•", lat: 34.5957, lng: 133.7712, icon: 'sight' },
                { time: "12:00", title: "Âè§Â∏ÇÁÉèÈæçÈ∫µ", desc: "ÂçàÈ§êÊé®Ëñ¶", lat: 34.5961, lng: 133.7692, link: "https://maps.app.goo.gl/6z3z3", icon: 'food' },
                { time: "14:00", title: "Ëå∂Â±ãÂ§ßÊ©ã", desc: "Ê∞¥ÊûúËÅñ‰ª£‰∏ãÂçàËå∂", lat: 34.5952, lng: 133.7720, icon: 'food' },
                { time: "17:00", title: "ËøîÂõûÈ´òÊùæ", desc: "ËªäÁ®ãÁ¥Ñ 1.5 - 2 Â∞èÊôÇ", lat: 34.3428, lng: 134.0466, icon: 'car' }
            ],
            note: "Ë®òÂæóÁïôËÇöÂ≠êÂêÉÁîúÈªûÔºÅ"
        },
        5: {
            title: "Day 5ÔΩúËøîÁ®ãÊó•",
            date: "1/27 (‰∫å)", location: "Takamatsu", lat: 34.3428, long: 134.0466,
            events: [
                { time: "10:00", title: "‰∏∏ÈæúÁî∫ Green", desc: "ÊúÄÂæåË°ùÂà∫Ë≥ºÁâ©", lat: 34.3444, lng: 134.0490, icon: 'shop' },
                { time: "11:30", title: "ÂõõÂúãÊ∞¥ÊóèÈ§®", desc: "(ÈÅ∏) È†ÜË∑ØÂèØÂéª", lat: 34.3093, lng: 133.7997, icon: 'sight' },
                { time: "14:30", title: "ÂâçÂæÄÊ©üÂ†¥", desc: "Âä†Ê≤π„ÄÅÈÇÑËªä", lat: 34.2142, lng: 134.0157, icon: 'car' },
                { time: "18:55", title: "CI179 Ëµ∑È£õËøîÂè∞", desc: "Bye Bye!", lat: 34.2142, lng: 134.0157, icon: 'plane' }
            ],
            note: "Ê∞¥ÊóèÈ§®Ë∑üÊ©üÂ†¥ÁÆóÈ†ÜË∑ØÔºå‰ΩÜË¶ÅÊäìÂ•ΩÈÇÑËªäÊôÇÈñì„ÄÇ"
        }
    };

    let currentDay3Mode = 'main';

    function loadDay(day) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        
        const bgText = document.getElementById('bgText');
        const snowContainer = document.getElementById('snowContainer');

        if (typeof day === 'number') {
            document.querySelectorAll('.tab-btn')[day - 1].classList.add('active');
            updateExp(day);
            renderSchedule(day);
            bgText.style.display = 'none';
            snowContainer.style.display = 'none';
        } else {
            document.querySelectorAll('.tab-btn')[5].classList.add('active');
            updateExp(5); 
            renderInfo();
            bgText.style.display = 'block';
            snowContainer.style.display = 'block';
            createSnow();
        }
    }

    function renderSchedule(day) {
        const data = itinerary[day];
        const content = document.getElementById('mainContent');
        
        fetchWeatherDetailed(data.lat, data.long, data.location);

        let html = `
            <div class="weather-panel">
                <div class="weather-left">
                    <div class="weather-loc">üìç ${data.location} ${data.date}</div>
                    <div id="weatherDesc" class="weather-detail">ËÆÄÂèñ‰∏≠...</div>
                </div>
                <div class="weather-right">
                    <span id="weatherIcon" class="weather-icon">ü§î</span>
                    <span id="weatherTemp" class="weather-temp">--¬∞</span>
                </div>
            </div>

            <h2 style="margin:0 0 15px 0; color:#333; border-bottom:2px dashed #AAA; padding-bottom:5px;">
                ${data.title}
            </h2>
        `;

        if (day === 3) {
            html += `
                <div class="sub-nav-container">
                    <button class="sub-nav-btn ${currentDay3Mode==='main'?'active-main':''}" onclick="switchDay3('main')">‚òÄ ‰∏ªÁ∑öÔºöÁà¨Â±±</button>
                    <button class="sub-nav-btn ${currentDay3Mode==='backup'?'active-backup':''}" onclick="switchDay3('backup')">‚òî ÂÇôÊ°àÔºöÁúãË≤ì</button>
                </div>
                <div id="day3ListContainer"></div>
            `;
            setTimeout(() => renderDay3List(), 0);
        } else {
            html += generateListHtml(data.events);
        }

        if(data.note) {
            html += `<div class="npc-dialog">${data.note}</div>`;
        }

        content.innerHTML = html + `<div id="bgText">Êµ∑Â∫ïÊíàÊúà</div>`; 
        document.getElementById('bgText').style.display = 'none'; 
        window.scrollTo(0,0);
    }

    function generateListHtml(events) {
        let listHtml = `<ul class="quest-list">`;
        events.forEach(event => {
            // Â∞éËà™ÈÄ£Áµê (ÈñãËªä)
            let navUrl = `https://www.google.com/maps/dir/?api=1&destination=${event.lat},${event.lng}&travelmode=driving`;
            
            // Ë≥áË®äÈÄ£Áµê (Êúâ link Áî® linkÔºåÊ≤íÊúâÂâáÊêúÂ∞ãÂú∞Âúñ)
            let infoUrl = event.link ? event.link : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.title)}&query_place_id=${event.lat},${event.lng}`;
            
            let iconHtml = '';
            // ‰ΩøÁî® Base64 ÂúñÁ§∫
            if(event.icon && ICONS[event.icon]) {
                iconHtml = `<img src="${ICONS[event.icon]}" class="event-icon-img">`;
            } else {
                // È†êË®≠ÂúñÁ§∫ (Â¶ÇÊûúÊ≤íË®≠ÂÆö)
                iconHtml = `<img src="${ICONS['sight']}" class="event-icon-img">`;
            }

            listHtml += `
                <li class="quest-item">
                    <div class="quest-header">
                        <span class="quest-time">${event.time}</span>
                        <span class="quest-title">${event.title} ${iconHtml}</span>
                    </div>
                    <div class="quest-desc">${event.desc}</div>
                    <div class="action-btns">
                        <a href="${navUrl}" target="_blank" class="btn btn-nav">üöó Â∞éËà™ GO</a>
                        <a href="${infoUrl}" target="_blank" class="btn btn-info">‚ÑπÔ∏è</a>
                    </div>
                </li>
            `;
        });
        listHtml += `</ul>`;
        return listHtml;
    }

    function switchDay3(mode) {
        currentDay3Mode = mode;
        const btns = document.querySelectorAll('.sub-nav-btn');
        btns[0].className = `sub-nav-btn ${mode==='main'?'active-main':''}`;
        btns[1].className = `sub-nav-btn ${mode==='backup'?'active-backup':''}`;
        renderDay3List();
    }

    function renderDay3List() {
        const container = document.getElementById('day3ListContainer');
        if(!container) return;
        const events = currentDay3Mode === 'main' ? itinerary[3].eventsMain : itinerary[3].eventsBackup;
        container.innerHTML = generateListHtml(events);
    }

    function renderInfo() {
        document.getElementById('mainContent').innerHTML = `
            <div id="bgText" style="display:block;">Êµ∑Â∫ïÊíàÊúà</div>
            <div style="text-align:center; padding-top:20px; position:relative; z-index:2;">
                <h2>üè† FAV HOTEL TAKAMATSU</h2>
                <p>È´òÊùæÂ∏Ç‰∏≠ÂøÉ</p>
                <a href="https://www.google.com/maps/search/?api=1&query=FAV+HOTEL+TAKAMATSU" target="_blank" class="btn btn-hotel">
                    üè® Â∞éËà™ÂéªÈ£ØÂ∫ó
                </a>
                <div class="npc-dialog">Á•ùÂ§ßÂÆ∂ÊóÖÈÄîÊÑâÂø´ÔºÅ<br>Èõ™Ëä±ÁâπÊïàËºâÂÖ•‰∏≠...</div>
            </div>
        `;
    }

    function updateExp(day) {
        let pct = 0;
        if(typeof day === 'number') {
            pct = Math.min(100, Math.round((day/5)*100));
        } else {
            pct = 100;
        }
        document.getElementById('expFill').style.width = pct + '%';
        document.getElementById('expText').innerText = pct + '%';
    }

    function createSnow() {
        const container = document.getElementById('snowContainer');
        container.innerHTML = '';
        for(let i=0; i<30; i++) {
            const snow = document.createElement('div');
            snow.className = 'snowflake';
            snow.innerText = '‚ùÑ';
            snow.style.left = Math.random() * 100 + 'vw';
            snow.style.animationDuration = Math.random() * 3 + 2 + 's';
            snow.style.fontSize = Math.random() * 10 + 10 + 'px';
            container.appendChild(snow);
        }
    }

    async function fetchWeatherDetailed(lat, long, loc) {
        const tEl = document.getElementById('weatherTemp');
        const dEl = document.getElementById('weatherDesc');
        const iEl = document.getElementById('weatherIcon');
        
        if(!tEl) return;
        tEl.innerText = "--"; dEl.innerText = "ËÆÄÂèñ‰∏≠..."; iEl.innerText = "‚è≥";

        try {
            const r = Date.now();
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${long}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo&t=${r}`;
            
            const res = await fetch(url);
            if(!res.ok) throw new Error("API Error");
            const data = await res.json();
            
            const current = data.current_weather;
            const daily = data.daily;
            const temp = Math.round(current.temperature);
            const max = Math.round(daily.temperature_2m_max[0]);
            const min = Math.round(daily.temperature_2m_min[0]);
            const rainProb = daily.precipitation_probability_max[0];
            const code = current.weathercode;

            let iconChar = "‚òÄ"; let statusText = "Êô¥Êúó";
            if (code >= 71 && code <= 77) { iconChar = "‚ùÑÔ∏è"; statusText = "‰∏ãÈõ™"; }
            else if ((code >= 51 && code <= 67) || (code >= 80 && code <= 82)) { iconChar = "üåß"; statusText = "ÊúâÈõ®"; }
            else if (code === 45 || code === 48) { iconChar = "üå´"; statusText = "ÊúâÈúß"; }
            else if (code >= 1 && code <= 3) { iconChar = "‚õÖ"; statusText = "Â§öÈõ≤"; } 
            else { iconChar = "‚òÄ"; statusText = "Êô¥Êúó"; }

            tEl.innerText = `${temp}¬∞`;
            iEl.innerText = iconChar;
            dEl.innerHTML = `${statusText} (ÈôçÈõ® ${rainProb}%)<br>È´ò ${max}¬∞ / ‰Ωé ${min}¬∞`;

        } catch(e) {
            console.log("Weather Error:", e);
            tEl.innerText = "?"; iEl.innerText = "‚ö†Ô∏è";
            dEl.innerHTML = `ÁÑ°Ê≥ïËÆÄÂèñ<br><a href="https://www.google.com/search?q=weather+${loc}" target="_blank" class="weather-fallback-btn">üîç Google Â§©Ê∞£</a>`;
        }
    }

    loadDay(1);
</script>

</body>
</html>
