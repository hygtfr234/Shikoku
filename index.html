<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å››åœ‹å†’éšªæ—¥èªŒ V14.0</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&family=Noto+Serif+TC:wght@900&display=swap" rel="stylesheet">
    <style>
        :root { --maple-bg: #87CEEB; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: var(--maple-bg);
            /* èƒŒæ™¯åœ– */
            background-image: url('https://i.pinimg.com/originals/1e/86/82/1e8682d029094054a138c2084c83091e.jpg');
            background-size: cover; background-attachment: fixed; background-position: center bottom;
            margin: 0; padding: 8px; color: #333; padding-bottom: 60px; overflow-x: hidden;
        }

        .quest-window {
            max-width: 600px; margin: 5px auto; background: #FFF;
            border: 3px solid #8B4513; border-radius: 12px;
            box-shadow: 0 0 0 4px #DAA520, 0 10px 20px rgba(0,0,0,0.5); 
            overflow: hidden; position: relative; z-index: 10;
        }

        .window-header {
            background: linear-gradient(to bottom, #4b6cb7, #182848);
            padding: 10px 15px; color: white; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 4px solid #DAA520;
        }

        .header-icon {
            width: 40px; height: 40px; object-fit: contain; margin-right: 10px;
            filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.5)); animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* Tabs */
        .tabs { display: flex; width: 100%; background: #6D4C41; border-bottom: 2px solid #3E2723; }
        .tab-btn {
            flex: 1; background: linear-gradient(to bottom, #8D6E63, #5D4037);
            border-right: 1px solid #4E342E; border-bottom: none; padding: 10px 0; cursor: pointer;
            font-weight: 800; color: #DDD; font-size: 16px; text-align: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-shadow: 1px 1px 0 #000;
        }
        .tab-btn:last-child { border-right: none; }
        .tab-btn.active { background: #FFF; color: #3E2723; text-shadow: none; box-shadow: inset 0 -4px 0 #FFCC00; }
        .tab-sub { font-size: 11px; font-weight: normal; color: #AAA; margin-top: 2px; }
        .tab-btn.active .tab-sub { color: #555; font-weight: bold; }

        .content-area { background: #FFF; padding: 15px; min-height: 480px; position: relative; }

        /* å¤©æ°£é¢æ¿ (ä¿®æ­£ç‰ˆ) */
        .weather-panel {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border: 2px solid #1E88E5; border-radius: 12px; padding: 12px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: space-between; box-shadow: 3px 3px 0 rgba(0,0,0,0.1);
        }
        .weather-left { display: flex; flex-direction: column; }
        .weather-loc { font-size: 15px; font-weight: 900; color: #1565C0; }
        .weather-detail { font-size: 12px; color: #0D47A1; margin-top: 4px; font-weight: bold;}
        .weather-right { text-align: right; display: flex; align-items: center; gap: 5px; }
        .weather-icon-img { width: 45px; height: 45px; object-fit: contain; filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.1)); }
        .weather-temp { font-size: 26px; color: #D84315; font-weight: 900; }
        .weather-fallback-btn {
            display: inline-block; background: #fff; color: #1565C0; text-decoration: none;
            padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: bold;
            margin-top: 5px; border: 1px solid #1565C0;
        }

        /* å°èˆªæŒ‰éˆ• (è¶…ç´šç¬ç§»ä¹‹çŸ³) */
        .btn-nav { 
            flex: 1; background: linear-gradient(to bottom, #4facfe, #00f2fe); padding: 10px; 
            border: 1px solid #0091EA; box-shadow: 0 4px 0 #006064; text-shadow: 0 1px 1px rgba(0,0,0,0.3);
            text-decoration: none; color: white; display: flex; align-items: center; justify-content: center;
            border-radius: 8px; font-weight: bold; font-size: 15px;
        }
        .btn-nav:active { box-shadow: 0 0 0 #006064; transform: translateY(4px); }
        
        /* è³‡è¨ŠæŒ‰éˆ• (ä¸€èˆ¬é»ƒè‰²æŒ‰éˆ•) */
        .btn-info { 
            width: 60px; background: linear-gradient(to bottom, #ffd200, #f7971e); color: white; font-size: 20px; 
            border: 1px solid #F57F17; box-shadow: 0 4px 0 #E65100; font-family: serif; font-weight: bold;
            display: flex; align-items: center; justify-content: center; border-radius: 8px;
        }
        .btn-info:active { box-shadow: 0 0 0 #E65100; transform: translateY(4px); }
        
        .btn-hotel { 
            width:100%; background: linear-gradient(to bottom, #ff758c, #ff7eb3); font-size: 20px; padding: 15px; margin-top: 10px; 
            border-radius: 8px; color: white; text-decoration: none; font-weight: bold; display: block; text-align: center; 
            border: 1px solid #C2185B; box-shadow: 0 4px 0 #880E4F; text-shadow: 0 1px 1px rgba(0,0,0,0.3);
        }
        .btn-hotel:active { box-shadow: 0 0 0 #880E4F; transform: translateY(4px); }
        
        .action-btns { display: flex; gap: 8px; margin-top: 10px; }

        /* è¡Œç¨‹åˆ—è¡¨ */
        .quest-list { list-style: none; padding: 0; margin: 0; }
        .quest-item { border-bottom: 2px dashed #D7CCC8; padding: 15px 0; }
        .quest-item:last-child { border-bottom: none; }
        .quest-header { display: flex; align-items: center; margin-bottom: 8px; }
        .quest-time {
            background: #3E2723; color: #FFD54F; padding: 3px 8px; border-radius: 4px;
            font-size: 14px; font-weight: bold; margin-right: 10px; min-width: 60px; text-align: center;
            border: 1px solid #FFECB3;
        }
        .quest-title { font-size: 18px; font-weight: 800; color: #5D4037; display: flex; align-items: center; }
        .quest-desc { font-size: 15px; color: #555; margin: 0 0 12px 0; line-height: 1.4; padding-left: 2px; }
        
        .event-icon-img { 
            width: 32px; height: 32px; margin-left: 8px; 
            object-fit: contain; vertical-align: middle; 
            display: inline-block; filter: drop-shadow(1px 1px 0 rgba(0,0,0,0.2));
        }

        /* ç¶“é©—å€¼æ¢ */
        .exp-bar-container {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 35px;
            background: #2b2b2b; border-top: 2px solid #FFD700;
            display: flex; align-items: center; padding: 0 15px; z-index: 999;
        }
        .exp-track { flex: 1; height: 12px; background: #111; border-radius: 8px; overflow: hidden; border: 1px solid #555; }
        .exp-fill { height: 100%; background: linear-gradient(to bottom, #00FF00, #00CC00); width: 0%; transition: 0.5s; }

        /* NPC å°è©±æ¡† (è‡è‡å¯¶è²å›æ­¸) */
        .npc-dialog {
            background: #FFF8DC; border: 2px solid #DAA520; border-radius: 12px;
            padding: 15px 15px 15px 65px; position: relative; margin-top: 25px;
            font-size: 14px; line-height: 1.6; color: #4A3B2A; box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }
        .npc-dialog::before {
            content: ''; width: 50px; height: 50px;
            background-image: url('https://maplestory.io/api/gms/62/mob/1210102/render/move?center=true');
            background-size: contain; background-repeat: no-repeat;
            position: absolute; left: 8px; top: 50%; transform: translateY(-50%);
        }

        .sub-nav-container { display: flex; gap: 10px; margin-bottom: 20px; background: #EEE; padding: 5px; border-radius: 8px; }
        .sub-nav-btn { flex: 1; padding: 10px; border: 2px solid transparent; border-radius: 6px; font-weight: bold; cursor: pointer; background: #CCC; color: #555; }
        .sub-nav-btn.active-main { background: #FFF; border-color: #FFCC00; color: #333; }
        .sub-nav-btn.active-backup { background: #E6E6FA; border-color: #9370DB; color: #4B0082; }

        /* --- INFO é é¢å°ˆå±¬æ¨£å¼ --- */
        .papulatus-wrapper {
            position: relative;
            text-align: center;
            margin-top: 10px;
            height: 250px; /* å›ºå®šé«˜åº¦é¿å…è·‘ç‰ˆ */
        }
        .haidilao-text {
            font-family: 'Noto Serif TC', serif; 
            font-size: 40px; 
            font-weight: 900;
            color: #d32f2f;
            text-shadow: 2px 2px 0 #FFF, -1px -1px 0 #FFF, 1px -1px 0 #FFF, -1px 1px 0 #FFF, 1px 1px 0 #FFF;
            position: absolute;
            top: 0; left: 50%; transform: translateX(-50%);
            z-index: 5;
        }
        .papulatus-img {
            width: 140px;
            position: absolute;
            top: 50px; left: 50%; transform: translateX(-50%);
            animation: float 3s ease-in-out infinite;
            z-index: 2;
        }
        /* æ‡¸æµ®è£å‚™ */
        .drop-item {
            width: 40px; height: 40px; position: absolute;
            animation: bounceDrop 2s infinite;
            filter: drop-shadow(0 0 5px yellow);
        }
        .drop-1 { top: 80px; left: 20%; animation-delay: 0s; } /* çœ¼é£¾ */
        .drop-2 { top: 60px; right: 20%; animation-delay: 0.5s; } /* é‘°åŒ™ */
        .drop-3 { top: 140px; right: 25%; animation-delay: 1s; } /* ç™¼æ¢ */

        @keyframes float { 0%, 100% { top: 50px; } 50% { top: 40px; } }
        @keyframes bounceDrop { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* å»£æ’­æ¡† */
        .chat-log {
            background: rgba(0,0,0,0.7);
            border-radius: 4px;
            padding: 8px;
            color: #FFF;
            font-size: 13px;
            text-align: left;
            margin: 10px auto;
            width: 95%;
            font-family: 'Arial', sans-serif; /* æ¨¡æ“¬éŠæˆ²å­—é«” */
            line-height: 1.4;
        }
        .chat-name { color: #FFFF00; font-weight: bold; } /* é»ƒè‰² ID */
        .chat-content { color: #FFF; }

    </style>
</head>
<body>

<div class="quest-window">
    <div class="window-header">
        <div style="display:flex; align-items:center;">
            <img src="https://maplestory.io/api/gms/62/mob/1210100/render/move?center=true" class="header-icon" alt="icon">
            <div style="font-size:18px; text-shadow:1px 1px 0 #000;">ğŸ è³œåœ‹ç©å››åœ‹</div>
        </div>
        <div style="font-size:12px; background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px;">LV.2026 æ—¥æœ¬å››åœ‹åˆå¿ƒè€…</div>
    </div>

    <div class="tabs">
        <div class="tab-btn active" onclick="loadDay(1)">D1<span class="tab-sub">é«˜æ¾</span></div>
        <div class="tab-btn" onclick="loadDay(2)">D2<span class="tab-sub">å°è±†å³¶</span></div>
        <div class="tab-btn" onclick="loadDay(3)">D3<span class="tab-sub">é‡‘åˆ€æ¯”ç¾…</span></div>
        <div class="tab-btn" onclick="loadDay(4)">D4<span class="tab-sub">å€‰æ•·</span></div>
        <div class="tab-btn" onclick="loadDay(5)">D5<span class="tab-sub">è¿”ç¨‹</span></div>
        <div class="tab-btn" onclick="loadDay('info')">INFO<span class="tab-sub">ä½å®¿</span></div>
    </div>

    <div class="content-area" id="mainContent">
        <!-- JS å…§å®¹æ¸²æŸ“ -->
    </div>
</div>

<div class="exp-bar-container">
    <span style="color:#FFCC00; font-weight:900; margin-right:10px;">EXP</span>
    <div class="exp-track"><div class="exp-fill" id="expFill"></div></div>
    <span style="color:white; font-size:12px; margin-left:10px;" id="expText">0%</span>
</div>

<script>
    // =========================================================
    // ğŸ¨ å…§å»º Base64 åœ–ç¤º (è¯èˆªé£›æ©Ÿ)
    // =========================================================
    const PLANE_ICON = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjRTMwMDc5IiBkPSJNMzUuNCAyNDQuOGMtMi45IDguNSAxLjYgMTcuNyAxMC4zIDIwLjUgOC43IDIuOCAxOC4xLTIgMjEuMS0xMC41IDMuMS04LjYtMS42LTE3LjktMTAuNC0yMC43LTguNi0yLjgtMTguMSAxLjktMjEgMTAuN3ptMTI4LjIgOTEuMWMtMTYuNy01LjMtMjUuMSA4LjgtMTguNCAxOS45IDUuMiA4LjUgMTkuMiA5LjIgMzEuOSAzLjggMTEuNy01IDExLjItMTcuNS41LTIxLjQtNC4xLTEuNS05LjItMi4yLTE0LTIuM3ptLTgwLjUgNzEuOGMtMTQuMyAxNS41IDUgMzIuMyAyMS40IDMwLjUgMTIuOS0xLjQgMTguNi0xMi42IDE0LjUtMjIuOS0zLjMtOC40LTE1LjYtMTQuNC0yNi41LTEyLjN6bTMxOS41LTg4LjJjLTE4LjUgMjMuNi00Ny41IDM4LjMtNjQuMyA1My4yLTIyLjYgMjAuMS0yNS4xIDUyLjEtMy41IDczLjEgMjEuNCAyMC45IDU4LjMgMTYuNCA4My44LTEwLjIgMjMuNS0yNC42IDMyLjUtNTcuMyAxNS45LTk4LjctNi41LTE2LjEtMTgtMTkuOS0zMS45LTE3LjR6bS0xMzUuMy01LjRjLTEuOS0xNS41LTE2LjgtMjEuMy0zMy0xMi45LTE2LjEgOC40LTE2LjggMjguNi0xLjMgMzQuNCAxMS42IDQuMyAyNy41LTMuMyAzMi43LTE2LjEgMS4xLTIuNyAxLjYtNS40IDEuNi01LjR6bTE0LjkgMTY4LjJjLTI1LjEgNi42LTI4LjIgNDAuNS00LjUgNDguMyAxOC42IDYuMSAzNy44LTE1IDMxLjQtMzcuNS0zLjUtMTIuMy0xNi45LTE1LjctMjYuOS0xMC44em0tMjIxLjYgMi44Yy04LjUgMTEuMS0yLjIgMjcuMiAxMS43IDI5LjUgMTEuMSAxLjkgMTguNC0xMC4xIDEyLjctMjAuNS00LjctOC41LTE1LjktMTQuOS0yNC40LTl6bTMzNi40LTI4LjRjLTIzLjUtOC42LTM1LjUgMTguNi0xOC40IDM2LjggMTMuNSAxNC4zIDM3LjMgNyAzOC0xMS44LjUtMTQuOC0xMC4xLTIxLjUtMTkuNi0yNXoiLz48L3N2Zz4=";

    // æ¥“ä¹‹è°·é“å…· URL (æ›´è±å¯Œ)
    const ROCK_ICON = "https://maplestory.io/api/gms/62/item/2040024/icon"; // ç¬ç§»ä¹‹çŸ³(å°èˆª)
    
    // è¡Œç¨‹é¡åˆ¥åœ–ç¤º (ä¸å†å…¨æ˜¯ç´…æ°´)
    const CAR_MOUNT = "https://maplestory.io/api/gms/62/item/1902000/icon"; // é‡è±¬(ç§Ÿè»Š)
    const BENTO = "https://maplestory.io/api/gms/62/item/2022000/icon"; // ä¾¿ç•¶(åˆé¤)
    const TREE_BRANCH = "https://maplestory.io/api/gms/62/item/4000003/icon"; // æ¨¹æ(å…¬åœ’)
    const GOLD_LEAF = "https://maplestory.io/api/gms/62/item/4001126/icon"; // æ¥“è‘‰(ç¥ç¤¾)
    const ICE_CREAM = "https://maplestory.io/api/gms/62/item/2020025/icon"; // å†°æ·‡æ·‹(ç”œé»)
    const SHOP_BAG = "https://maplestory.io/api/gms/62/item/4031138/icon"; // éŒ¢è¢‹(è³¼ç‰©)
    const FISH_ITEM = "https://maplestory.io/api/gms/62/item/4000259/icon"; // è¦å­(æ°´æ—é¤¨)
    const PET_FOOD = "https://maplestory.io/api/gms/62/item/2120000/icon"; // å¯µç‰©é£¼æ–™(è²“å³¶)
    const BOAT_ICON = "https://cdn-icons-png.flaticon.com/512/2942/2942544.png"; // èˆ¹(ç¶­æŒé€šç”¨)

    // å¤©æ°£åœ–ç¤º (æ¥“ä¹‹è°·é¢¨æ ¼)
    const WEATHER_SUN = "https://maplestory.io/api/gms/62/item/4000038/icon"; // å¤ªé™½ç¢ç‰‡
    const WEATHER_CLOUD = "https://maplestory.io/api/gms/62/item/4031579/icon"; // é›²æœµ
    const WEATHER_RAIN = "https://maplestory.io/api/gms/62/item/4000004/icon"; // æ°´æ»´
    const WEATHER_SNOW = "https://maplestory.io/api/gms/62/item/4000073/icon"; // é›ªèŠ±(å†°é¾é±—ç‰‡)

    const ICONS = {
        plane: PLANE_ICON,
        boat: BOAT_ICON,
        car: CAR_MOUNT,
        food: BENTO,
        sight: TREE_BRANCH,
        shrine: GOLD_LEAF,
        ice: ICE_CREAM,
        shop: SHOP_BAG,
        fish: FISH_ITEM,
        cat: PET_FOOD,
        rock: ROCK_ICON
    };

    // =========================================================
    // ğŸ“… è¡Œç¨‹è³‡æ–™ (V14.0)
    // =========================================================
    const itinerary = {
        1: {
            title: "Day 1ï½œæŠµé”é«˜æ¾",
            date: "1/23 (äº”)", location: "Takamatsu", lat: 34.3428, long: 134.0466,
            events: [
                // é£›æ©Ÿï¼šéš±è—å°èˆª (noNav)ï¼Œé€£çµæ”¾é£›æ©Ÿä»‹ç´¹
                { time: "07:00", title: "CI278 æ¡ƒåœ’èµ·é£›", desc: "å‰å¾€é«˜æ¾ï¼Œå†’éšªé–‹å§‹ï¼", lat: 25.0797, lng: 121.2342, icon: 'plane', noNav: true, link: "https://www.china-airlines.com/tw/zh" },
                { time: "10:20", title: "æŠµé”é«˜æ¾ç©ºæ¸¯", desc: "å…¥å¢ƒæ‰‹çºŒã€å–è»Š", lat: 34.2142, lng: 134.0157, icon: 'car' },
                { time: "12:00", title: "ç§Ÿè»Š & åˆé¤", desc: "æ¶®ä¹ƒè‘‰ (è£œå……é«”åŠ›)", lat: 34.2963, lng: 134.0441, link: "https://maps.app.goo.gl/KdNuojGtmtbTNwVn7", icon: 'food' },
                { time: "13:30", title: "æ —æ—å…¬åœ’", desc: "ç±³å…¶æ—ä¸‰æ˜Ÿåº­åœ’ (2H)", lat: 34.3297, lng: 134.0444, icon: 'sight' },
                { time: "17:30", title: "å•†åº—è¡—æ•£ç­–", desc: "å…«å¤§æ¢å•†åº—è¡—è‡ªç”±é€›", lat: 34.3444, lng: 134.0522, icon: 'shop' },
                { time: "18:30", title: "Vent Buffet", desc: "æ™šé¤æ™‚å…‰", lat: 34.3512, lng: 134.0560, link: "https://maps.app.goo.gl/uX7nC3x7z8x9", icon: 'food' }
            ],
            note: "ç¬¬ä¸€å¤©è¼•é¬†é»ï¼Œé©æ‡‰å³é§•ã€‚"
        },
        2: {
            title: "Day 2ï½œå°è±†å³¶",
            date: "1/24 (å…­)", location: "Shodoshima", lat: 34.4950, long: 134.2706,
            events: [
                { time: "08:00", title: "é«˜æ¾æ¸¯ â†’ åœŸåº„æ¸¯", desc: "æ­ä¹˜æ¸¡è¼ª (ç´„1H)", lat: 34.3524, lng: 134.0520, icon: 'boat' },
                { time: "09:30", title: "æ©„æ¬–å…¬åœ’", desc: "é­”å¥³å®…æ€¥ä¾¿æƒå¸šæ‹ç…§", lat: 34.4754, lng: 134.2947, icon: 'sight' },
                { time: "11:30", title: "é†¬ä¹‹é„‰", desc: "é†¬æ²¹éœœæ·‡æ·‹", lat: 34.4633, lng: 134.3317, icon: 'ice' },
                { time: "14:00", title: "å¤©ä½¿ä¹‹è·¯", desc: "é€€æ½®æ²™ç˜æ•£æ­¥", lat: 34.4746, lng: 134.1849, icon: 'sight' },
                { time: "16:00", title: "è¿”å›é«˜æ¾", desc: "æ­èˆ¹å›å¸‚å€", lat: 34.4827, lng: 134.1754, icon: 'boat' }
            ],
            note: `è‹¥æµ·æ³ä¸ä½³ï¼ŒBè¨ˆç•«æ”¹å»ã€Œæ»¿æ¿ƒå…¬åœ’ã€ã€‚<br><a href="https://www.google.com/maps/dir/?api=1&destination=34.1678,133.8647&travelmode=driving" target="_blank" style="color:red; font-weight:bold; text-decoration:underline;">ğŸ”´ é»æˆ‘é–‹å§‹å°èˆªå»æ»¿æ¿ƒå…¬åœ’</a>`
        },
        3: {
            title: "Day 3ï½œå½ˆæ€§é¸æ“‡æ—¥",
            date: "1/25 (æ—¥)", location: "Kotohira", lat: 34.1923, long: 133.8202,
            eventsMain: [
                { time: "09:00", title: "é‡‘åˆ€æ¯”ç¾…å®®", desc: "æŒ‘æˆ°1368éšæ¢¯ï¼Œåƒæ‹œç‹—ç‹—ç¥", lat: 34.1837, lng: 133.8122, icon: 'shrine' },
                { time: "12:30", title: "å±±è¶Šçƒé¾éºµ", desc: "çƒé¾éºµååº—åˆé¤", lat: 34.2384, lng: 133.9213, icon: 'food' },
                { time: "14:30", title: "æ»¿æ¿ƒå…¬åœ’", desc: "åœ‹ç‡Ÿå…¬åœ’è³èŠ±æ•£æ­¥", lat: 34.1678, lng: 133.8647, icon: 'sight' },
                { time: "18:00", title: "å¸‚å€æ™šé¤", desc: "è¿”å›é«˜æ¾", lat: 34.3428, lng: 134.0466, icon: 'food' }
            ],
            eventsBackup: [
                { time: "09:00", title: "å‰å¾€ç”·æœ¨å³¶", desc: "é«˜æ¾æ¸¯æ­èˆ¹å‰å¾€", lat: 34.3524, lng: 134.0520, icon: 'boat' },
                { time: "10:00", title: "ç”·æœ¨å³¶ (è²“å³¶)", desc: "è±ç‰å§¬ç¥ç¤¾ã€æ“¼è²“æ•£æ­¥", lat: 34.4262, lng: 134.0560, icon: 'cat' },
                { time: "13:00", title: "è¿”å›é«˜æ¾", desc: "å¸‚å€åˆé¤ & è³¼ç‰©", lat: 34.3428, lng: 134.0466, icon: 'shop' },
                { time: "15:00", title: "å®¤å…§è¡Œç¨‹", desc: "å•†åº—è¡— / å’–å•¡å»³ä¼‘æ¯", lat: 34.3444, lng: 134.0522, icon: 'food' }
            ],
            note: "æ ¹æ“šç•¶å¤©é«”åŠ›å’Œå¤©æ°£ï¼Œè‡ªç”±åˆ‡æ›ä¸Šæ–¹æŒ‰éˆ•é¸æ“‡è¡Œç¨‹ï¼"
        },
        4: {
            title: "Day 4ï½œå€‰æ•·ä¸€æ—¥éŠ",
            date: "1/26 (ä¸€)", location: "Kurashiki", lat: 34.5951, long: 133.7667,
            events: [
                { time: "08:00", title: "å‰å¾€å€‰æ•·", desc: "è‡ªé§•/JR (ç€¨æˆ¶å¤§æ©‹)", lat: 34.5951, lng: 133.7667, icon: 'car' },
                { time: "10:00", title: "å€‰æ•·ç¾è§€åœ°å€", desc: "é‹æ²³éŠèˆ¹ã€å¤è¡—æ•£æ­¥", lat: 34.5957, lng: 133.7712, icon: 'sight' },
                { time: "12:00", title: "å¤å¸‚çƒé¾éºµ", desc: "åˆé¤æ¨è–¦", lat: 34.5961, lng: 133.7692, link: "https://maps.app.goo.gl/6z3z3", icon: 'food' },
                { time: "14:00", title: "èŒ¶å±‹å¤§æ©‹", desc: "æ°´æœè–ä»£ä¸‹åˆèŒ¶", lat: 34.5952, lng: 133.7720, icon: 'ice' },
                { time: "17:00", title: "è¿”å›é«˜æ¾", desc: "è»Šç¨‹ç´„ 1.5 - 2 å°æ™‚", lat: 34.3428, lng: 134.0466, icon: 'car' }
            ],
            note: "è¨˜å¾—ç•™è‚šå­åƒç”œé»ï¼"
        },
        5: {
            title: "Day 5ï½œè¿”ç¨‹æ—¥",
            date: "1/27 (äºŒ)", location: "Takamatsu", lat: 34.3428, long: 134.0466,
            events: [
                { time: "10:00", title: "ä¸¸é¾œç”º Green", desc: "æœ€å¾Œè¡åˆºè³¼ç‰©", lat: 34.3444, lng: 134.0490, icon: 'shop' },
                { time: "11:30", title: "å››åœ‹æ°´æ—é¤¨", desc: "(é¸) é †è·¯å¯å»", lat: 34.3093, lng: 133.7997, icon: 'fish' },
                { time: "14:30", title: "å‰å¾€æ©Ÿå ´", desc: "åŠ æ²¹ã€é‚„è»Š", lat: 34.2142, lng: 134.0157, icon: 'car' },
                { time: "18:55", title: "CI179 èµ·é£›è¿”å°", desc: "Bye Bye!", lat: 34.2142, lng: 134.0157, icon: 'plane', noNav: true, link: "https://www.china-airlines.com/tw/zh" }
            ],
            note: "æ°´æ—é¤¨è·Ÿæ©Ÿå ´ç®—é †è·¯ï¼Œä½†è¦æŠ“å¥½é‚„è»Šæ™‚é–“ã€‚"
        }
    };

    let currentDay3Mode = 'main';

    function loadDay(day) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        
        if (typeof day === 'number') {
            document.querySelectorAll('.tab-btn')[day - 1].classList.add('active');
            updateExp(day);
            renderSchedule(day);
        } else {
            document.querySelectorAll('.tab-btn')[5].classList.add('active');
            updateExp(5); 
            renderInfo();
        }
    }

    function renderSchedule(day) {
        const data = itinerary[day];
        const content = document.getElementById('mainContent');
        
        // æŠ“å¤©æ°£
        fetchWeatherDetailed(data.lat, data.long, data.location);

        let html = `
            <div class="weather-panel">
                <div class="weather-left">
                    <div class="weather-loc">ğŸ“ ${data.location} ${data.date}</div>
                    <div id="weatherDesc" class="weather-detail">è®€å–ä¸­...</div>
                </div>
                <div class="weather-right">
                    <!-- é è¨­å¤ªé™½ -->
                    <img id="weatherIconImg" src="${WEATHER_SUN}" class="weather-icon-img" alt="weather">
                    <span id="weatherTemp" class="weather-temp">--Â°</span>
                </div>
            </div>

            <h2 style="margin:0 0 15px 0; color:#3E2723; border-bottom:2px dashed #AAA; padding-bottom:5px;">
                ${data.title}
            </h2>
        `;

        if (day === 3) {
            html += `
                <div class="sub-nav-container">
                    <button class="sub-nav-btn ${currentDay3Mode==='main'?'active-main':''}" onclick="switchDay3('main')">â˜€ ä¸»ç·šï¼šçˆ¬å±±</button>
                    <button class="sub-nav-btn ${currentDay3Mode==='backup'?'active-backup':''}" onclick="switchDay3('backup')">â˜” å‚™æ¡ˆï¼šçœ‹è²“</button>
                </div>
                <div id="day3ListContainer"></div>
            `;
            setTimeout(() => renderDay3List(), 0);
        } else {
            html += generateListHtml(data.events);
        }

        if(data.note) {
            html += `<div class="npc-dialog">${data.note}</div>`;
        }

        content.innerHTML = html;
        window.scrollTo(0,0);
    }

    function generateListHtml(events) {
        let listHtml = `<ul class="quest-list">`;
        events.forEach(event => {
            let navUrl = `https://www.google.com/maps/dir/?api=1&destination=${event.lat},${event.lng}&travelmode=driving`;
            let infoUrl = event.link ? event.link : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.title)}&query_place_id=${event.lat},${event.lng}`;
            
            // åœ–ç¤ºé‚è¼¯
            let iconSrc = ICONS['sight']; // é è¨­
            if (event.icon && ICONS[event.icon]) {
                iconSrc = ICONS[event.icon];
            }

            // åˆ¤æ–·æ˜¯å¦éš±è—å°èˆª (noNav)
            let navBtnHtml = '';
            if (!event.noNav) {
                navBtnHtml = `
                    <a href="${navUrl}" target="_blank" class="btn btn-nav">
                        <img src="${ICONS.rock}" style="width:20px; vertical-align:middle; margin-right:5px;">
                        å°èˆª GO
                    </a>`;
            }

            listHtml += `
                <li class="quest-item">
                    <div class="quest-header">
                        <span class="quest-time">${event.time}</span>
                        <span class="quest-title">
                            ${event.title} 
                            <img src="${iconSrc}" class="event-icon-img" alt="icon">
                        </span>
                    </div>
                    <div class="quest-desc">${event.desc}</div>
                    <div class="action-btns">
                        ${navBtnHtml}
                        <a href="${infoUrl}" target="_blank" class="btn btn-info">i</a>
                    </div>
                </li>
            `;
        });
        listHtml += `</ul>`;
        return listHtml;
    }

    function switchDay3(mode) {
        currentDay3Mode = mode;
        const btns = document.querySelectorAll('.sub-nav-btn');
        btns[0].className = `sub-nav-btn ${mode==='main'?'active-main':''}`;
        btns[1].className = `sub-nav-btn ${mode==='backup'?'active-backup':''}`;
        renderDay3List();
    }

    function renderDay3List() {
        const container = document.getElementById('day3ListContainer');
        if(!container) return;
        const events = currentDay3Mode === 'main' ? itinerary[3].eventsMain : itinerary[3].eventsBackup;
        container.innerHTML = generateListHtml(events);
    }

    function renderInfo() {
        document.getElementById('mainContent').innerHTML = `
            
            <div class="papulatus-wrapper">
                <div class="haidilao-text">æµ·åº•æ’ˆæœˆ</div>
                <img src="https://maplestory.io/api/gms/62/mob/8500001/render/move?center=true" class="papulatus-img" alt="papulatus">
                
                <!-- æ‡¸æµ®è£å‚™ -->
                <img src="https://maplestory.io/api/gms/62/item/1023348/icon" class="drop-item drop-1" title="æ‹‰åœ–æ–¯æ¨™èªŒ">
                <img src="https://maplestory.io/api/gms/62/item/4031179/icon" class="drop-item drop-2" title="ç•°ç•Œé‘°åŒ™">
                <img src="https://maplestory.io/api/gms/62/item/4000411/icon" class="drop-item drop-3" title="ç™¼æ¢">
            </div>

            <div class="chat-log">
                <span class="chat-name">:coward[é »é“228]:</span> 
                <span class="chat-content">å››åœ‹é€£5 ç¼º1å¥³é¢è³Š ç›´æ¥ä¾† å…ˆåˆ°å…ˆæ‰“ è«‹è‡ªå‚™1 NB 1 VPN</span>
            </div>

            <div style="text-align:center; padding-top:10px;">
                <h2>ğŸ  FAV HOTEL TAKAMATSU</h2>
                <p>é«˜æ¾å¸‚ä¸­å¿ƒ</p>
                <a href="https://www.google.com/maps/search/?api=1&query=FAV+HOTEL+TAKAMATSU" target="_blank" class="btn btn-hotel">
                    <img src="${ROCK_ICON}" style="width:24px; vertical-align:middle; margin-right:5px;">
                    å°èˆªå»é£¯åº—
                </a>
            </div>
        `;
    }

    function updateExp(day) {
        let pct = 0;
        if(typeof day === 'number') {
            pct = Math.min(100, Math.round((day/5)*100));
        } else {
            pct = 100;
        }
        document.getElementById('expFill').style.width = pct + '%';
        document.getElementById('expText').innerText = pct + '%';
    }

    // å¤©æ°£ API (ä¿®æ­£ç‰ˆï¼šä½¿ç”¨ç•¶å‰å¤©æ°£)
    async function fetchWeatherDetailed(lat, long, loc) {
        const tEl = document.getElementById('weatherTemp');
        const dEl = document.getElementById('weatherDesc');
        const iImg = document.getElementById('weatherIconImg');
        
        if(!tEl) return;
        tEl.innerText = "--"; dEl.innerText = "è®€å–ä¸­..."; 

        try {
            // ä½¿ç”¨ current_weather åƒæ•¸ç¢ºä¿èƒ½æŠ“åˆ°
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${long}&current_weather=true&timezone=Asia%2FTokyo`;
            
            const res = await fetch(url);
            if(!res.ok) throw new Error("API Error");
            const data = await res.json();
            
            const current = data.current_weather;
            const temp = Math.round(current.temperature);
            const code = current.weathercode;

            let iconSrc = WEATHER_SUN;
            let statusText = "æ™´æœ—";

            // WMO Weather Codes to Maple Items
            if (code >= 71) { iconSrc = WEATHER_SNOW; statusText = "ä¸‹é›ª"; }
            else if (code >= 51) { iconSrc = WEATHER_RAIN; statusText = "æœ‰é›¨"; }
            else if (code >= 45) { iconSrc = WEATHER_CLOUD; statusText = "æœ‰éœ§"; }
            else if (code >= 1) { iconSrc = WEATHER_CLOUD; statusText = "å¤šé›²"; } 
            
            tEl.innerText = `${temp}Â°`;
            iImg.src = iconSrc;
            dEl.innerText = `${statusText} (å³æ™‚)`;

        } catch(e) {
            console.log("Weather Error:", e);
            tEl.innerText = "?";
            dEl.innerHTML = `<a href="https://www.google.com/search?q=weather+${loc}" target="_blank" class="weather-fallback-btn">ğŸ” é»æˆ‘çœ‹å¤©æ°£</a>`;
        }
    }

    loadDay(1);
</script>

</body>
</html>
